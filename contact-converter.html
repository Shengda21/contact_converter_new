<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI联系人转换器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .loading { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
                    📇 AI联系人转换器
                </h1>
                <p class="text-gray-600 text-center mb-6">
                    将文字信息智能转换为iPhone通讯录可导入的vCard格式
                </p>

                <!-- 模式切换 -->
                <div class="flex justify-center mb-8">
                    <div class="bg-gray-100 p-1 rounded-lg">
                        <button id="singleModeBtn" class="px-6 py-2 rounded-md font-medium transition-all duration-200 bg-white text-blue-600 shadow-sm">
                            🔄 单个转换
                        </button>
                        <button id="batchModeBtn" class="px-6 py-2 rounded-md font-medium transition-all duration-200 text-gray-600 hover:text-gray-800">
                            📚 批量转换
                        </button>
                    </div>
                </div>

                <!-- 批量联系人列表 -->
                <div id="batchContactsList" class="mb-6 p-4 bg-blue-50 rounded-lg hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 id="batchContactsTitle" class="text-lg font-semibold text-blue-800">
                            批量联系人列表 (0个)
                        </h3>
                        <button id="clearBatchBtn" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            🗑️ 清空列表
                        </button>
                    </div>
                    <div id="batchContactsContainer" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- 动态添加联系人 -->
                    </div>
                </div>

                <!-- LLM配置面板 -->
                <div id="llmConfigPanel" class="mb-8 p-6 bg-purple-50 rounded-lg border-2 border-purple-200 hidden">
                    <h3 class="text-xl font-semibold text-purple-800 mb-4">🤖 LLM配置</h3>
                    
                    <div class="space-y-4">
                        <!-- LLM选择 -->
                        <div class="flex gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="llmChoice" value="claude" checked class="text-purple-600">
                                <span class="text-gray-700 font-medium">🔮 使用Claude (默认)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="llmChoice" value="custom" class="text-purple-600">
                                <span class="text-gray-700 font-medium">🏠 使用自定义LLM</span>
                            </label>
                        </div>

                        <!-- 自定义LLM配置 -->
                        <div id="customLLMConfig" class="mt-4 p-4 bg-white rounded-lg border space-y-3 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    API地址 (Base URL)
                                </label>
                                <input type="text" id="apiBaseURL" value="http://localhost:1234/v1" 
                                       placeholder="http://localhost:1234/v1"
                                       class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                                <p class="text-xs text-gray-500 mt-1">
                                    支持OpenAI兼容的API，如LMStudio、Ollama、vLLM等
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    API密钥 (可选)
                                </label>
                                <input type="password" id="apiKey" 
                                       placeholder="sk-xxx (本地模型通常不需要)"
                                       class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    模型名称
                                </label>
                                <input type="text" id="modelName" value="llama-3-8b-instruct" 
                                       placeholder="llama-3-8b-instruct"
                                       class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                            </div>
                            
                            <div class="mt-3 p-3 bg-blue-50 rounded text-sm">
                                <div class="font-medium text-blue-800 mb-1">💡 常用配置示例：</div>
                                <div class="text-blue-700 space-y-1">
                                    <div>• <strong>LM Studio</strong>: http://localhost:1234/v1</div>
                                    <div>• <strong>Ollama</strong>: http://localhost:11434/v1</div>
                                    <div>• <strong>vLLM</strong>: http://localhost:8000/v1</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                当前使用：<span id="currentLLMStatus" class="font-medium text-purple-600">Claude (Anthropic)</span>
                            </div>
                            <button id="saveLLMConfigBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                                ✅ 保存配置
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <!-- 输入区域 -->
                    <div class="space-y-4">
                        <h2 id="inputSectionTitle" class="text-xl font-semibold text-gray-700">输入联系人信息</h2>
                        
                        <textarea id="inputText" 
                                placeholder="请输入或粘贴联系人信息，例如：&#10;&#10;张三&#10;手机：13800138000&#10;邮箱：zhangsan@example.com&#10;公司：ABC科技有限公司&#10;职位：产品经理"
                                class="w-full h-64 p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>

                        <div class="flex gap-3">
                            <button id="pasteBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200">
                                📋 粘贴
                            </button>
                            <button id="llmConfigBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 text-sm">
                                ⚙️ LLM配置
                            </button>
                            <button id="convertBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200">
                                🤖 AI转换
                            </button>
                        </div>
                    </div>

                    <!-- 输出区域 -->
                    <div class="space-y-4">
                        <h2 id="outputSectionTitle" class="text-xl font-semibold text-gray-700">vCard输出</h2>
                        
                        <textarea id="outputText" readonly 
                                placeholder="转换后的vCard内容将显示在这里..."
                                class="w-full h-64 p-4 border border-gray-300 rounded-lg resize-none bg-gray-50 font-mono text-sm"></textarea>

                        <div id="outputButtons" class="flex gap-3 hidden">
                            <button id="copyBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200">
                                📋 复制
                            </button>
                            <button id="downloadBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200">
                                💾 下载.vcf文件
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 使用说明 -->
                <div class="mt-8 p-6 bg-blue-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">使用说明</h3>
                    <div class="text-blue-700 space-y-2 text-sm">
                        <div class="font-medium">🔄 单个转换模式：</div>
                        <ul class="ml-4 space-y-1">
                            <li>• 在左侧输入框中输入或粘贴联系人信息</li>
                            <li>• 点击"AI转换"按钮，AI将自动识别并转换为vCard格式</li>
                            <li>• 下载生成的.vcf文件，然后在iPhone上打开即可导入通讯录</li>
                        </ul>
                        
                        <div class="font-medium pt-2">📚 批量转换模式：</div>
                        <ul class="ml-4 space-y-1">
                            <li>• 切换到批量模式，可以连续添加多个联系人</li>
                            <li>• 输入联系人信息后点击"添加到列表"，联系人会被添加到批量列表</li>
                            <li>• 输入框会自动清空，可以继续添加下一个联系人</li>
                            <li>• 所有联系人的vCard会合并在一个.vcf文件中，方便批量导入</li>
                            <li>• 可以在列表中删除不需要的联系人或清空整个列表</li>
                        </ul>
                        
                        <div class="font-medium pt-2">🤖 AI智能识别能力：</div>
                        <ul class="ml-4 space-y-1">
                            <li>• **基本信息**：姓名、电话、邮箱地址</li>
                            <li>• **工作信息**：公司/机构名称、职位/职务/身份</li>
                            <li>• **教育背景**：毕业院校、学历、专业、导师信息</li>
                            <li>• **专业领域**：研究方向、技能特长、工作经验</li>
                            <li>• **地址信息**：工作地址、联系地址（如有）</li>
                            <li>• **补充信息**：所有有价值的信息都会整理到NOTE字段</li>
                        </ul>
                        
                        <div class="font-medium pt-2">⚙️ LLM配置：</div>
                        <ul class="ml-4 space-y-1">
                            <li>• 默认使用Claude提供最佳识别效果</li>
                            <li>• 支持本地LLM：LM Studio、Ollama、vLLM等</li>
                            <li>• 兼容OpenAI API格式的所有大模型</li>
                            <li>• 可自定义API地址、密钥和模型名称</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 应用状态
        let appState = {
            batchMode: false,
            isConverting: false,
            batchContacts: [],
            useCustomLLM: false,
            customAPI: {
                baseURL: 'http://localhost:1234/v1',
                apiKey: '',
                model: 'llama-3-8b-instruct'
            }
        };

        // DOM元素
        const elements = {
            singleModeBtn: document.getElementById('singleModeBtn'),
            batchModeBtn: document.getElementById('batchModeBtn'),
            batchContactsList: document.getElementById('batchContactsList'),
            batchContactsTitle: document.getElementById('batchContactsTitle'),
            batchContactsContainer: document.getElementById('batchContactsContainer'),
            clearBatchBtn: document.getElementById('clearBatchBtn'),
            llmConfigPanel: document.getElementById('llmConfigPanel'),
            llmConfigBtn: document.getElementById('llmConfigBtn'),
            saveLLMConfigBtn: document.getElementById('saveLLMConfigBtn'),
            customLLMConfig: document.getElementById('customLLMConfig'),
            currentLLMStatus: document.getElementById('currentLLMStatus'),
            apiBaseURL: document.getElementById('apiBaseURL'),
            apiKey: document.getElementById('apiKey'),
            modelName: document.getElementById('modelName'),
            inputSectionTitle: document.getElementById('inputSectionTitle'),
            outputSectionTitle: document.getElementById('outputSectionTitle'),
            inputText: document.getElementById('inputText'),
            outputText: document.getElementById('outputText'),
            pasteBtn: document.getElementById('pasteBtn'),
            convertBtn: document.getElementById('convertBtn'),
            outputButtons: document.getElementById('outputButtons'),
            copyBtn: document.getElementById('copyBtn'),
            downloadBtn: document.getElementById('downloadBtn')
        };

        // 工具函数
        function extractNameFromVCard(vCard) {
            const fnMatch = vCard.match(/FN:(.+)/);
            return fnMatch ? fnMatch[1].trim() : '未知联系人';
        }

        function updateBatchResult() {
            const combinedVCards = appState.batchContacts.map(contact => contact.vCard).join('\n\n');
            elements.outputText.value = combinedVCards;
            updateUI();
        }

        function updateUI() {
            // 更新模式按钮
            if (appState.batchMode) {
                elements.singleModeBtn.className = 'px-6 py-2 rounded-md font-medium transition-all duration-200 text-gray-600 hover:text-gray-800';
                elements.batchModeBtn.className = 'px-6 py-2 rounded-md font-medium transition-all duration-200 bg-white text-blue-600 shadow-sm';
                elements.inputSectionTitle.textContent = '输入联系人信息（批量模式）';
                elements.outputSectionTitle.textContent = `vCard输出 (${appState.batchContacts.length}个联系人)`;
                elements.convertBtn.textContent = '➕ 添加到列表';
                elements.inputText.placeholder = "请输入或粘贴联系人信息，转换后将添加到批量列表中：\n\n张三\n手机：13800138000\n邮箱：zhangsan@example.com\n公司：ABC科技有限公司\n职位：产品经理\n\n转换完成后可继续添加下一个联系人...";
                elements.outputText.placeholder = "批量转换的vCard内容将显示在这里...\n所有联系人的vCard将合并在一个文件中";
            } else {
                elements.singleModeBtn.className = 'px-6 py-2 rounded-md font-medium transition-all duration-200 bg-white text-blue-600 shadow-sm';
                elements.batchModeBtn.className = 'px-6 py-2 rounded-md font-medium transition-all duration-200 text-gray-600 hover:text-gray-800';
                elements.inputSectionTitle.textContent = '输入联系人信息';
                elements.outputSectionTitle.textContent = 'vCard输出';
                elements.convertBtn.textContent = '🤖 AI转换';
                elements.inputText.placeholder = "请输入或粘贴联系人信息，例如：\n\n张三\n手机：13800138000\n邮箱：zhangsan@example.com\n公司：ABC科技有限公司\n职位：产品经理";
                elements.outputText.placeholder = "转换后的vCard内容将显示在这里...";
            }

            // 更新批量联系人列表
            if (appState.batchMode && appState.batchContacts.length > 0) {
                elements.batchContactsList.classList.remove('hidden');
                elements.batchContactsTitle.textContent = `批量联系人列表 (${appState.batchContacts.length}个)`;
                elements.batchContactsContainer.innerHTML = appState.batchContacts.map(contact => `
                    <div class="flex justify-between items-center bg-white p-2 rounded">
                        <span class="text-sm text-gray-700 font-medium">${contact.name}</span>
                        <button onclick="removeBatchContact(${contact.id})" class="text-red-500 hover:text-red-700 text-xs">
                            ✕ 删除
                        </button>
                    </div>
                `).join('');
            } else {
                elements.batchContactsList.classList.add('hidden');
            }

            // 更新转换按钮状态
            if (appState.isConverting) {
                elements.convertBtn.textContent = '🔄 转换中...';
                elements.convertBtn.disabled = true;
                elements.convertBtn.classList.add('loading');
            } else {
                elements.convertBtn.disabled = false;
                elements.convertBtn.classList.remove('loading');
            }

            // 更新输出按钮
            const hasOutput = elements.outputText.value.trim();
            if (hasOutput) {
                elements.outputButtons.classList.remove('hidden');
                const buttonSuffix = appState.batchMode ? `(${appState.batchContacts.length}个)` : '';
                elements.copyBtn.textContent = `📋 复制${buttonSuffix}`;
                elements.downloadBtn.textContent = `💾 下载.vcf文件${buttonSuffix}`;
            } else {
                elements.outputButtons.classList.add('hidden');
            }

            // 更新LLM状态显示
            if (appState.useCustomLLM) {
                elements.currentLLMStatus.textContent = `${appState.customAPI.model} (${appState.customAPI.baseURL})`;
            } else {
                elements.currentLLMStatus.textContent = 'Claude (Anthropic)';
            }
        }

        // 事件处理函数
        function toggleBatchMode() {
            appState.batchMode = !appState.batchMode;
            elements.outputText.value = '';
            elements.inputText.value = '';
            if (!appState.batchMode) {
                appState.batchContacts = [];
            }
            updateUI();
        }

        function removeBatchContact(id) {
            appState.batchContacts = appState.batchContacts.filter(contact => contact.id !== id);
            updateBatchResult();
        }

        function clearBatch() {
            appState.batchContacts = [];
            elements.outputText.value = '';
            updateUI();
        }

        async function handlePaste() {
            try {
                const text = await navigator.clipboard.readText();
                elements.inputText.value = text;
            } catch (err) {
                alert('无法访问剪贴板，请手动粘贴内容');
                console.error('Failed to read clipboard contents: ', err);
            }
        }

        async function handleConvert() {
            if (!elements.inputText.value.trim()) {
                alert('请先输入或粘贴要转换的文字');
                return;
            }

            appState.isConverting = true;
            if (!appState.batchMode) {
                elements.outputText.value = '';
            }
            updateUI();

            try {
                let response;
                const inputText = elements.inputText.value;
                
                const promptContent = `请仔细分析以下文字，智能提取所有可能的联系人信息并转换为完整的vCard格式。请根据文本内容灵活识别各种信息字段：

文字内容：
${inputText}

提取要求：
1. **基本信息**：姓名(FN/N)、电话(TEL)、邮箱(EMAIL)
2. **工作信息**：公司/机构(ORG)、职位/职务(TITLE)
3. **地址信息**：如有地址信息请提取(ADR)
4. **教育背景**：学历、毕业院校、专业、导师等信息
5. **专业领域**：研究方向、技能、专长等
6. **其他信息**：任何有价值的补充信息

输出格式要求：
- 严格按照vCard 3.0标准格式
- 根据提取到的信息灵活包含相应字段：
  * FN: 全名
  * N: 姓;名;;;
  * ORG: 公司/机构名称
  * TITLE: 职位/职务/身份
  * TEL: 电话号码
  * EMAIL: 邮箱地址
  * ADR: 地址信息（如有）
  * NOTE: 教育背景、专业方向、技能等补充信息
- 如果某个字段信息不明确或缺失，可以不包含该字段
- NOTE字段用于存放教育背景、专业方向、技能特长等重要补充信息
- 确保格式完全正确，能被iPhone通讯录识别
- 只输出vCard内容，不要包含任何markdown格式或其他文字

示例输出格式：
BEGIN:VCARD
VERSION:3.0
FN:张三
N:张;三;;;
ORG:ABC科技有限公司
TITLE:产品经理
TEL:13800138000
EMAIL:zhangsan@example.com
ADR:;;北京市海淀区中关村大街1号;;;中国
NOTE:清华大学计算机科学与技术专业硕士，专注于人工智能和机器学习领域，有5年产品设计经验
END:VCARD

请根据实际提取到的信息生成vCard，不要生成示例中的虚假信息。`;

                if (appState.useCustomLLM) {
                    // 使用自定义LLM API
                    if (!appState.customAPI.baseURL) {
                        alert('请先配置自定义LLM的API地址');
                        appState.isConverting = false;
                        updateUI();
                        return;
                    }
                    
                    const headers = {
                        "Content-Type": "application/json",
                    };
                    
                    if (appState.customAPI.apiKey) {
                        headers["Authorization"] = `Bearer ${appState.customAPI.apiKey}`;
                    }
                    
                    response = await fetch(`${appState.customAPI.baseURL}/chat/completions`, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            model: appState.customAPI.model,
                            max_tokens: 1000,
                            messages: [
                                {
                                    role: "user",
                                    content: promptContent
                                }
                            ]
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        var vCardContent = data.choices[0].message.content.trim();
                    } else {
                        throw new Error('自定义LLM响应格式异常');
                    }
                    
                } else {
                    // 使用Claude API
                    response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: [
                                {
                                    role: "user",
                                    content: promptContent
                                }
                            ]
                        })
                    });

                    const data = await response.json();
                    var vCardContent = data.content[0].text.trim();
                }
                
                if (appState.batchMode) {
                    // 批量模式：添加到联系人列表
                    const newContact = {
                        id: Date.now(),
                        originalText: inputText,
                        vCard: vCardContent,
                        name: extractNameFromVCard(vCardContent)
                    };
                    appState.batchContacts.push(newContact);
                    updateBatchResult();
                    elements.inputText.value = ''; // 清空输入框准备下一个
                    alert(`联系人已添加到批量列表！当前共有 ${appState.batchContacts.length} 个联系人`);
                } else {
                    // 单个模式：直接显示结果
                    elements.outputText.value = vCardContent;
                }
            } catch (error) {
                alert(`转换失败：${error.message}，请检查LLM配置或重试`);
                console.error('Conversion error:', error);
            } finally {
                appState.isConverting = false;
                updateUI();
            }
        }

        function toggleLLMConfig() {
            elements.llmConfigPanel.classList.toggle('hidden');
        }

        function updateLLMChoice() {
            const choice = document.querySelector('input[name="llmChoice"]:checked').value;
            appState.useCustomLLM = choice === 'custom';
            
            if (appState.useCustomLLM) {
                elements.customLLMConfig.classList.remove('hidden');
            } else {
                elements.customLLMConfig.classList.add('hidden');
            }
            updateUI();
        }

        function saveLLMConfig() {
            if (appState.useCustomLLM) {
                appState.customAPI.baseURL = elements.apiBaseURL.value;
                appState.customAPI.apiKey = elements.apiKey.value;
                appState.customAPI.model = elements.modelName.value;
            }
            elements.llmConfigPanel.classList.add('hidden');
            updateUI();
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(elements.outputText.value);
                const message = appState.batchMode ? 
                    `批量vCard内容已复制到剪贴板（共${appState.batchContacts.length}个联系人）` : 
                    'vCard内容已复制到剪贴板';
                alert(message);
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('复制失败，请手动复制');
            }
        }

        function downloadVCard() {
            const content = elements.outputText.value;
            if (!content) return;

            const blob = new Blob([content], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const fileName = appState.batchMode ? `contacts_batch_${appState.batchContacts.length}.vcf` : 'contact.vcf';
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 事件监听器
        elements.singleModeBtn.addEventListener('click', () => {
            if (appState.batchMode) toggleBatchMode();
        });

        elements.batchModeBtn.addEventListener('click', () => {
            if (!appState.batchMode) toggleBatchMode();
        });

        elements.clearBatchBtn.addEventListener('click', clearBatch);
        elements.pasteBtn.addEventListener('click', handlePaste);
        elements.convertBtn.addEventListener('click', handleConvert);
        elements.llmConfigBtn.addEventListener('click', toggleLLMConfig);
        elements.saveLLMConfigBtn.addEventListener('click', saveLLMConfig);
        elements.copyBtn.addEventListener('click', copyToClipboard);
        elements.downloadBtn.addEventListener('click', downloadVCard);

        // LLM选择监听器
        document.querySelectorAll('input[name="llmChoice"]').forEach(radio => {
            radio.addEventListener('change', updateLLMChoice);
        });

        // 初始化UI
        updateUI();
    </script>
</body>
</html>